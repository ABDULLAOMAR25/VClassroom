<!-- live_video_classroom.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Video Classroom</title>
  <!-- âœ… Correct LiveKit SDK CDN -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.min.js"></script>
  <link rel="stylesheet" href="/static/styles.css" /> <!-- Assuming you have an external CSS file -->
  <style>
    /* Inline styles preserved (optional) */
    /* ...[CSS code from your original head section]... */
  </style>
</head>
<body>
  <header>Live Video Classroom</header>
  <div id="main">
    <div id="left-panel">
      <div id="video-container">
        <video id="local-video" autoplay muted playsinline></video>
        <video id="remote-video" autoplay playsinline></video>
      </div>
      <div id="controls">
        <button id="btnCamera">ðŸ“· Start Camera</button>
        <button id="btnMic" disabled>ðŸŽ¤ Mic On</button>
        <button id="btnRaiseHand">âœ‹ Raise Hand</button>
      </div>
    </div>
    <div id="right-panel">
      <div id="participants">
        <strong>Participants:</strong>
        <ul id="participant-list"></ul>
      </div>
      <div id="chat">
        <div id="messages"></div>
        <div id="chat-input">
          <input type="text" id="messageBox" placeholder="Type a message..." />
          <button id="btnSend">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… JS logic with server values injected -->
  <script>
    const roomName = "{{ room_name }}";
    const identity = "{{ identity }}";

    let room;
    let localTracks = [];
    let micEnabled = true;

    async function connectToRoom() {
      try {
        const res = await fetch("/get_token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room: roomName, identity })
        });
        const { token } = await res.json();
        const livekitServerUrl = "wss://vclassroom-wwi9i8el.livekit.cloud";

        room = new Livekit.Room();

        room.on("connected", () => {
          addParticipant(room.localParticipant);
          room.participants.forEach(addParticipant);
        });
        room.on("participantConnected", addParticipant);
        room.on("participantDisconnected", removeParticipant);
        room.on("trackSubscribed", (track, pub, participant) => {
          if (track.kind === "video") {
            track.attach(document.getElementById("remote-video"));
          } else if (track.kind === "audio") {
            track.attach();
          }
        });

        await room.connect(livekitServerUrl, token);
        alert("âœ… Connected! Click Start Camera");
      } catch (err) {
        alert("Connection error: " + err.message);
      }
    }

    function addParticipant(participant) {
      const li = document.createElement("li");
      li.id = participant.sid;
      li.textContent = participant.identity;
      document.getElementById("participant-list").appendChild(li);
    }

    function removeParticipant(participant) {
      const el = document.getElementById(participant.sid);
      if (el) el.remove();
    }

    async function startCamera() {
      if (!room) return alert("Not connected yet");
      if (localTracks.length) return;

      localTracks = await Livekit.createLocalTracks({ audio: true, video: true });
      for (const track of localTracks) {
        await room.localParticipant.publishTrack(track);
        if (track.kind === "video") {
          track.attach(document.getElementById("local-video"));
        }
      }
      document.getElementById("btnMic").disabled = false;
    }

    function toggleMic() {
      const audioTrack = localTracks.find(t => t.kind === "audio");
      micEnabled = !micEnabled;
      micEnabled ? audioTrack.enable() : audioTrack.disable();
      document.getElementById("btnMic").textContent = micEnabled ? "ðŸŽ¤ Mic On" : "ðŸ”‡ Mic Off";
    }

    function raiseHand() {
      const div = document.createElement("div");
      div.textContent = `${identity} âœ‹ raised hand.`;
      document.getElementById("messages").appendChild(div);
    }

    function sendMessage() {
      const input = document.getElementById("messageBox");
      const div = document.createElement("div");
      div.textContent = `${identity}: ${input.value}`;
      document.getElementById("messages").appendChild(div);
      input.value = "";
    }

    document.getElementById("btnCamera").onclick = startCamera;
    document.getElementById("btnMic").onclick = toggleMic;
    document.getElementById("btnRaiseHand").onclick = raiseHand;
    document.getElementById("btnSend").onclick = sendMessage;

    connectToRoom();
  </script>
</body>
</html>
