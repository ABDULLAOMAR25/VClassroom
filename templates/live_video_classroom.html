<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Video Classroom</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        video {
            width: 45%;
            margin: 10px;
            border-radius: 10px;
        }
        #controls {
            margin: 20px;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center">üî¥ Live Class - Room {{ room_name }}</h2>
    <div style="display: flex; justify-content: center; flex-wrap: wrap;">
        <video id="local-video" autoplay muted playsinline></video>
        <video id="remote-video" autoplay playsinline></video>
    </div>

    <div id="controls" style="text-align:center;">
        <button onclick="disconnect()">üö™ Leave Room</button>
    </div>

    <script src="https://unpkg.com/@livekit/client/dist/livekit-client.min.js"></script>
    <script>
        const roomName = "{{ room_name }}";
        const identity = "{{ identity }}";
        const livekitUrl = "";

        let room;

        async function connectToRoom() {
            try {
                const response = await fetch("/get_token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ room: roomName, identity: identity })
                });

                const data = await response.json();
                if (!data.token || !data.url) {
                    alert("‚ùå Failed to get token. Make sure you're logged in.");
                    return;
                }

                room = new LivekitRoom.LiveKitRoom({
                    url: data.url,
                    token: data.token
                });

                const localVideoEl = document.getElementById("local-video");
                const remoteVideoEl = document.getElementById("remote-video");

                await room.connect();

                const localTracks = await LivekitRoom.createLocalTracks();
                for (const track of localTracks) {
                    room.localParticipant.publishTrack(track);
                    if (track.kind === "video") {
                        track.attach(localVideoEl);
                    }
                }

                room.on("trackSubscribed", (track, publication, participant) => {
                    if (track.kind === "video") {
                        track.attach(remoteVideoEl);
                    }
                });

                room.on("disconnected", () => {
                    console.log("Disconnected from room");
                });

            } catch (error) {
                console.error("Error connecting to room:", error);
                alert("‚ö†Ô∏è Could not connect to LiveKit room.");
            }
        }

        function disconnect() {
            if (room) {
                room.disconnect();
            }
            window.location.href = "/sessions";
        }

        connectToRoom();
    </script>
</body>
</html>
