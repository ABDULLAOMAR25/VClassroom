<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Live Video Classroom</title>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/livekit-client/2.14.0/livekit-client.umd.min.js"></script>
Â  <style>
Â  Â  * {
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  }
Â  Â  body {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  height: 100vh;
Â  Â  Â  background-color: #f0f2f5;
Â  Â  }
Â  Â  header {
Â  Â  Â  padding: 1rem;
Â  Â  Â  background-color: #2d3436;
Â  Â  Â  color: white;
Â  Â  Â  text-align: center;
Â  Â  Â  font-size: 1.5rem;
Â  Â  }
Â  Â  #main {
Â  Â  Â  display: flex;
Â  Â  Â  flex: 1;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #left-panel {
Â  Â  Â  flex: 3;
Â  Â  Â  padding: 1rem;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  #video-container {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }
Â  Â  video {
Â  Â  Â  width: 45%;
Â  Â  Â  max-width: 480px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  background: black;
Â  Â  }
Â  Â  #controls {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  Â  justify-content: center;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  #controls button {
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  background-color: #0984e3;
Â  Â  Â  color: white;
Â  Â  Â  transition: background-color 0.3s;
Â  Â  }
Â  Â  #controls button:hover {
Â  Â  Â  background-color: #74b9ff;
Â  Â  }
Â  Â  #right-panel {
Â  Â  Â  flex: 1;
Â  Â  Â  background: #fff;
Â  Â  Â  border-left: 1px solid #ddd;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  #participants {
Â  Â  Â  flex: 1;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 1rem;
Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  }
Â  Â  #chat {
Â  Â  Â  flex: 2;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  padding: 1rem;
Â  Â  }
Â  Â  #messages {
Â  Â  Â  flex: 1;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  padding: 10px;
Â  Â  Â  background-color: #fafafa;
Â  Â  }
Â  Â  #chat-input {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  #chat-input input {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 10px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 5px;
Â  Â  }
Â  Â  #chat-input button {
Â  Â  Â  padding: 10px;
Â  Â  Â  background-color: #00b894;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>Live Video Classroom - Room {{ room_name }}</header>
Â  <div id="main">
Â  Â  <div id="left-panel">
Â  Â  Â  <div id="video-container">
Â  Â  Â  Â  <video id="local-video" autoplay muted playsinline></video>
Â  Â  Â  </div>
Â  Â  Â  <div id="controls">
Â  Â  Â  Â  <button id="btnCamera">ðŸ“· Camera</button>
Â  Â  Â  Â  <button id="btnMic">ðŸŽ¤ Mic On</button>
Â  Â  Â  Â  <button id="btnRaiseHand">âœ‹ Raise Hand</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="right-panel">
Â  Â  Â  <div id="participants">
Â  Â  Â  Â  <strong>Participants:</strong>
Â  Â  Â  Â  <ul id="participant-list"></ul>
Â  Â  Â  </div>
Â  Â  Â  <div id="chat">
Â  Â  Â  Â  <div id="messages"></div>
Â  Â  Â  Â  <div id="chat-input">
Â  Â  Â  Â  Â  <input type="text" id="messageBox" placeholder="Type a message..." />
Â  Â  Â  Â  Â  <button id="btnSend">Send</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // Room name from Flask/Jinja or fallback to last URL segment
Â  Â  let roomName = "{{ room_name }}";
Â  Â  if (!roomName || roomName === "") {
Â  Â  Â  roomName = window.location.pathname.split("/").pop();
Â  Â  }

Â  Â  // User identity from Flask/Jinja or fallback random ID
Â  Â  let identity = "{{ identity }}";
Â  Â  if (!identity || identity === "") {
Â  Â  Â  identity = "user-" + Math.floor(Math.random() * 1000);
Â  Â  }

Â  Â  let room;
Â  Â  let localTracks = [];
Â  Â  let micEnabled = true;

Â  Â  async function connectToRoom() {
Â  Â  Â  try {
Â  Â  Â  Â  // Request LiveKit token and url from backend
Â  Â  Â  Â  const res = await fetch("/get_token", {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ room: roomName, identity: identity }),
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!res.ok) throw new Error("Failed to get token from server");

Â  Â  Â  Â  const { token, url } = await res.json();
Â  Â  Â  Â  if (!token || !url) throw new Error("Token or URL missing in server response");

Â  Â  Â  Â  // Create LiveKit room instance
Â  Â  Â  Â  room = new LivekitClient.Room();

Â  Â  Â  Â  // Subscribe and attach remote tracks (video and audio)
Â  Â  Â  Â  room.on("trackSubscribed", (track, publication, participant) => {
Â  Â  Â  Â  Â  const attachedEl = track.attach();
Â  Â  Â  Â  Â  if (track.kind === "video") {
Â  Â  Â  Â  Â  Â  attachedEl.autoplay = true;
Â  Â  Â  Â  Â  Â  attachedEl.playsInline = true;
Â  Â  Â  Â  Â  Â  attachedEl.style.borderRadius = "12px";
Â  Â  Â  Â  Â  Â  attachedEl.style.width = "45%";
Â  Â  Â  Â  Â  Â  attachedEl.style.background = "black";
Â  Â  Â  Â  Â  Â  document.getElementById("video-container").appendChild(attachedEl);
Â  Â  Â  Â  Â  } else if (track.kind === "audio") {
Â  Â  Â  Â  Â  Â  // Audio element plays sound but is hidden
Â  Â  Â  Â  Â  Â  attachedEl.style.display = "none";
Â  Â  Â  Â  Â  Â  document.body.appendChild(attachedEl);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Update participant list on connect and disconnect
Â  Â  Â  Â  room.on("participantConnected", participant => {
Â  Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  Â  li.id = participant.sid;
Â  Â  Â  Â  Â  li.textContent = participant.identity;
Â  Â  Â  Â  Â  document.getElementById("participant-list").appendChild(li);
Â  Â  Â  Â  });

Â  Â  Â  Â  room.on("participantDisconnected", participant => {
Â  Â  Â  Â  Â  const li = document.getElementById(participant.sid);
Â  Â  Â  Â  Â  if (li) li.remove();
Â  Â  Â  Â  });

Â  Â  Â  Â  // Log disconnection
Â  Â  Â  Â  room.on("disconnected", () => {
Â  Â  Â  Â  Â  console.log("Room disconnected");
Â  Â  Â  Â  });

Â  Â  Â  Â  // Receive "raise-hand" messages via LiveKit data channel
Â  Â  Â  Â  room.on("dataReceived", (payload, participant) => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const message = JSON.parse(new TextDecoder().decode(payload));
Â  Â  Â  Â  Â  Â  if (message.type === "raise-hand") {
Â  Â  Â  Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  Â  Â  Â  div.textContent = `${message.from} âœ‹ raised hand`;
Â  Â  Â  Â  Â  Â  Â  const msgBox = document.getElementById("messages");
Â  Â  Â  Â  Â  Â  Â  msgBox.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  msgBox.scrollTop = msgBox.scrollHeight;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error parsing data message", e);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  await room.connect(url, token);

Â  Â  Â  Â  alert("âœ… Connected to LiveKit room: " + roomName + " as " + identity);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert("âŒ Error: " + err.message);
Â  Â  Â  Â  console.error("Connection error:", err);
Â  Â  Â  }
Â  Â  }

Â  Â  async function startCamera() {
Â  Â  Â  try {
Â  Â  Â  Â  if (!room) return alert("Not connected to room");

Â  Â  Â  Â  // Create and publish local audio and video tracks
Â  Â  Â  Â  localTracks = await LivekitClient.createLocalTracks({ audio: true, video: true });

Â  Â  Â  Â  for (const track of localTracks) {
Â  Â  Â  Â  Â  await room.localParticipant.publishTrack(track);

Â  Â  Â  Â  Â  if (track.kind === "video") {
Â  Â  Â  Â  Â  Â  const videoEl = track.attach();
Â  Â  Â  Â  Â  Â  videoEl.id = "local-video";
Â  Â  Â  Â  Â  Â  videoEl.autoplay = true;
Â  Â  Â  Â  Â  Â  videoEl.muted = true; // mute to avoid echo
Â  Â  Â  Â  Â  Â  videoEl.playsInline = true;
Â  Â  Â  Â  Â  Â  videoEl.style.borderRadius = "12px";
Â  Â  Â  Â  Â  Â  videoEl.style.width = "45%";
Â  Â  Â  Â  Â  Â  videoEl.style.background = "black";

Â  Â  Â  Â  Â  Â  const container = document.getElementById("video-container");
Â  Â  Â  Â  Â  Â  const oldVideo = document.getElementById("local-video");
Â  Â  Â  Â  Â  Â  if (oldVideo) oldVideo.remove();

Â  Â  Â  Â  Â  Â  container.appendChild(videoEl);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  console.log("âœ… Camera and mic started");
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("âŒ Camera error:", err);
Â  Â  Â  Â  alert("Could not start camera: " + err.message);
Â  Â  Â  }
Â  Â  }

Â  Â  function toggleMic() {
Â  Â  Â  const audioTrack = localTracks.find(t => t.kind === "audio");
Â  Â  Â  if (!audioTrack) return;
Â  Â  Â  micEnabled = !micEnabled;
Â  Â  Â  micEnabled ? audioTrack.enable() : audioTrack.disable();
Â  Â  Â  document.getElementById("btnMic").textContent = micEnabled ? "ðŸŽ¤ Mic On" : "ðŸŽ¤ Mic Off";
Â  Â  }

Â  Â  function raiseHand() {
Â  Â  Â  if (!room) return;
Â  Â  Â  room.localParticipant.publishData(
Â  Â  Â  Â  new TextEncoder().encode(JSON.stringify({ type: "raise-hand", from: identity })),
Â  Â  Â  Â  { reliable: true }
Â  Â  Â  );
Â  Â  }

Â  Â  // Basic local chat messages (not synchronized)
Â  Â  function sendMessage() {
Â  Â  Â  const input = document.getElementById("messageBox");
Â  Â  Â  if (!input.value.trim()) return;
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  div.textContent = `${identity}: ${input.value}`;
Â  Â  Â  const msgBox = document.getElementById("messages");
Â  Â  Â  msgBox.appendChild(div);
Â  Â  Â  input.value = "";
Â  Â  Â  msgBox.scrollTop = msgBox.scrollHeight;
Â  Â  }

Â  Â  // Attach button listeners
Â  Â  document.getElementById("btnCamera").onclick = startCamera;
Â  Â  document.getElementById("btnMic").onclick = toggleMic;
Â  Â  document.getElementById("btnRaiseHand").onclick = raiseHand;
Â  Â  document.getElementById("btnSend").onclick = sendMessage;

Â  Â  // Connect immediately on page load
Â  Â  connectToRoom();
Â  </script>
</body>
</html>
